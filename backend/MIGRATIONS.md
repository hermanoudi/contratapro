# Guia de MigraÃ§Ãµes de Banco de Dados

Este projeto utiliza **Alembic** para gerenciar migraÃ§Ãµes de banco de dados com SQLAlchemy async.

## ğŸ“‹ Ãndice

- [Estrutura](#estrutura)
- [Comandos BÃ¡sicos](#comandos-bÃ¡sicos)
- [Workflow de Desenvolvimento](#workflow-de-desenvolvimento)
- [Deploy em ProduÃ§Ã£o](#deploy-em-produÃ§Ã£o)
- [Troubleshooting](#troubleshooting)

## ğŸ—‚ï¸ Estrutura

```
backend/
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ versions/          # Arquivos de migration
â”‚   â”œâ”€â”€ env.py            # ConfiguraÃ§Ã£o do Alembic (async)
â”‚   â””â”€â”€ script.py.mako    # Template para novas migrations
â”œâ”€â”€ alembic.ini           # ConfiguraÃ§Ã£o principal
â”œâ”€â”€ migrate.sh            # Script helper para migrations
â””â”€â”€ MIGRATIONS.md         # Este arquivo
```

## ğŸš€ Comandos BÃ¡sicos

### Usando o Script Helper (Recomendado)

```bash
# Aplicar todas as migrations pendentes
./migrate.sh upgrade

# Criar nova migration (autogenerate)
./migrate.sh create "adicionar_campo_email"

# Ver versÃ£o atual do banco
./migrate.sh current

# Ver histÃ³rico de migrations
./migrate.sh history

# Reverter Ãºltima migration
./migrate.sh downgrade
```

### Usando Alembic Diretamente

```bash
# Aplicar migrations
python3 -m alembic upgrade head

# Criar migration manual
python3 -m alembic revision -m "descricao"

# Criar migration com autogenerate
python3 -m alembic revision --autogenerate -m "descricao"

# Reverter para versÃ£o especÃ­fica
python3 -m alembic downgrade <revision_id>

# Ver SQL que serÃ¡ executado (dry run)
python3 -m alembic upgrade head --sql
```

## ğŸ’» Workflow de Desenvolvimento

### 1. Modificar Models

Edite seus models em `app/models.py`:

```python
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True)  # Novo campo
```

### 2. Criar Migration

```bash
./migrate.sh create "adicionar_email_usuario"
```

Isso cria um arquivo em `alembic/versions/` com o timestamp.

### 3. Revisar Migration

**IMPORTANTE**: Sempre revise o arquivo gerado antes de aplicar!

```python
def upgrade() -> None:
    # Verifique se as alteraÃ§Ãµes estÃ£o corretas
    op.add_column('users', sa.Column('email', sa.String(), nullable=True))
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)

def downgrade() -> None:
    # Garanta que o rollback funciona corretamente
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_column('users', 'email')
```

### 4. Aplicar Migration

```bash
./migrate.sh upgrade
```

### 5. Testar Rollback (Opcional)

```bash
./migrate.sh downgrade  # Reverte Ãºltima migration
./migrate.sh upgrade    # Reaplica
```

## ğŸ­ Deploy em ProduÃ§Ã£o

### OpÃ§Ã£o 1: Via Docker Compose

```yaml
# docker-compose.yml
services:
  backend:
    build: ./backend
    command: >
      sh -c "python3 -m alembic upgrade head &&
             uvicorn app.main:app --host 0.0.0.0 --port 8000"
```

### OpÃ§Ã£o 2: Script de Deploy

```bash
#!/bin/bash
# deploy.sh

# 1. Pull do cÃ³digo
git pull origin main

# 2. Rebuild da aplicaÃ§Ã£o
docker-compose build backend

# 3. Parar serviÃ§o
docker-compose stop backend

# 4. Aplicar migrations
docker-compose run --rm backend python3 -m alembic upgrade head

# 5. Reiniciar serviÃ§o
docker-compose up -d backend
```

### OpÃ§Ã£o 3: CI/CD (GitHub Actions)

```yaml
# .github/workflows/deploy.yml
- name: Run migrations
  run: |
    docker-compose run --rm backend python3 -m alembic upgrade head
```

## ğŸ”§ Troubleshooting

### Erro: "Can't locate revision"

**Problema**: Banco estÃ¡ em estado inconsistente.

**SoluÃ§Ã£o**:
```bash
# Ver versÃ£o atual
./migrate.sh current

# Marcar versÃ£o manualmente
python3 -m alembic stamp head
```

### Erro: "Target database is not up to date"

**Problema**: Migrations pendentes.

**SoluÃ§Ã£o**:
```bash
./migrate.sh upgrade
```

### Autogenerate nÃ£o detecta alteraÃ§Ãµes

**Problema**: Models nÃ£o foram importados em `alembic/env.py`.

**SoluÃ§Ã£o**: Verifique se todos os models estÃ£o importados:

```python
# alembic/env.py
from app.models import (
    User, Service, WorkingHour, Appointment,
    Subscription, Category
)
```

### Erro de conexÃ£o com banco

**Problema**: URL de conexÃ£o incorreta.

**SoluÃ§Ã£o**: Verifique `.env`:

```bash
DATABASE_URL=postgresql+asyncpg://user:pass@host:5432/dbname
```

### Rollback de migration em produÃ§Ã£o

**CUIDADO**: Pode causar perda de dados!

```bash
# 1. Fazer backup primeiro!
pg_dump -h localhost -U postgres faz_de_tudo > backup.sql

# 2. Reverter migration
./migrate.sh downgrade

# 3. Se algo der errado, restaurar backup
psql -h localhost -U postgres faz_de_tudo < backup.sql
```

## ğŸ“ Boas PrÃ¡ticas

### âœ… Fazer

- âœ… Sempre revisar migrations autogenerated
- âœ… Testar migrations em ambiente de staging primeiro
- âœ… Fazer backup antes de migrations em produÃ§Ã£o
- âœ… Versionar arquivos de migration no Git
- âœ… Usar nomes descritivos nas migrations
- âœ… Testar tanto upgrade quanto downgrade
- âœ… Adicionar Ã­ndices para campos frequentemente consultados

### âŒ Evitar

- âŒ Editar migrations jÃ¡ aplicadas em produÃ§Ã£o
- âŒ Fazer migrations direto em produÃ§Ã£o sem testar
- âŒ Deletar arquivos de migration do histÃ³rico
- âŒ Modificar dados (usar data migrations separadas)
- âŒ Criar migrations gigantes (dividir em partes menores)

## ğŸ”„ EstratÃ©gia de Versionamento

### ConvenÃ§Ã£o de Nomes

```
YYYYMMDD_HHMM-<revision_id>_<descricao>.py
```

Exemplo:
```
20260105_1330-abc123def456_adicionar_campo_email.py
```

### Branches e Migrations

**Desenvolvimento em feature branches**:

1. Criar branch: `git checkout -b feature/novo-campo`
2. Modificar models
3. Criar migration: `./migrate.sh create "novo_campo"`
4. Commit: `git commit -am "feat: adicionar novo campo"`
5. Merge para main

**Conflitos de migration**:

Se dois desenvolvedores criarem migrations em paralelo:

```bash
# Resolver conflito manualmente
python3 -m alembic merge <rev1> <rev2>
```

## ğŸ“š ReferÃªncias

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Async](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [FastAPI + Alembic](https://fastapi.tiangolo.com/tutorial/sql-databases/)

---

**Ãšltima atualizaÃ§Ã£o**: 2026-01-05
**VersÃ£o**: 1.0.0
