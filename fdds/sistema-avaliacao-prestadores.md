FDD: Sistema de Avaliação de Prestadores (ContrataPro)Versão: 1.0Data: 09/02/2026Responsável: [Seu Nome/Responsável Técnico]1. Contexto e motivação técnicaImplementação de um sistema de feedback pós-serviço para o ecossistema ContrataPro. O objetivo é permitir que clientes avaliem a execução dos serviços, alimentando a reputação dos prestadores na plataforma. Tecnicamente, a feature resolve a lacuna de dados sobre qualidade, utilizando gatilhos manuais (botão Concluir) e automáticos (Scheduler) para garantir a coleta de dados sem depender exclusivamente da proatividade do profissional.2. Objetivos técnicosIdempotência de Envio: Garantir que apenas um e-mail de avaliação seja gerado por booking_id, evitando spam por concorrência entre o clique manual e o Scheduler.Processamento Não-Bloqueante: Utilizar background_tasks do FastAPI para que o envio de e-mails e atualização de médias não aumente o tempo de resposta das APIs.Integridade Reputacional: Garantir que a nota média mostrada no perfil seja o reflexo fiel e atualizado da soma de todas as avaliações válidas.3. Escopo e exclusõesIncluídoGeração de Token UUID único para link de avaliação.Endpoint de submissão de avaliação (Rating, Comentário, Nome, Data/Hora).Scheduler diário para conclusão automática de serviços atrasados.Novo endpoint para resumo de avaliações do prestador (Média e Histórico).Integração com Resend para disparo de e-mails.ExcluídoEdição ou exclusão de avaliações pelo cliente após o envio.Moderação automática de conteúdo ofensivo nos comentários.Notificações via WhatsApp ou Push.4. Fluxos detalhados e diagramasFluxo principal (Via Botão Concluir)Profissional clica em "Concluir" no dashboard.Backend altera status do serviço para COMPLETED.Sistema gera um Token UUID vinculado ao booking_id.Uma background_task dispara o e-mail via Resend com o link único.Cliente abre o link, preenche os dados e submete.Sistema valida o token, salva a Review e atualiza a média do prestador de forma assíncrona.Fluxo de contingência (Scheduler)Uma vez ao dia, o Scheduler identifica serviços com data/hora de término passada e status AGENDADO.O sistema executa o passo 2 ao 4 do fluxo principal para cada serviço encontrado.5. Contratos públicos (assinaturas, endpoints, headers, exemplos)[Submissão de Avaliação]Tipo: endpointRota: POST /v1/reviews/{token}Método: POSTSemântica de status/headers:201 Created: Avaliação registrada com sucesso.404 Not Found: Token inexistente ou inválido.409 Conflict: Avaliação já realizada para este link.Exemplo de requisiçãoJSON{
  "rating": 5,
  "comment": "O serviço de escova ficou excelente e a profissional foi muito pontual.",
  "customer_name": "Dayane Carolina de Oliveira",
  "evaluated_at": "2026-02-09T14:30:00Z"
}
[Resumo do Prestador]Tipo: endpointRota: GET /v1/providers/{provider_id}/reviews-summaryMétodo: GETExemplo de respostaJSON{
  "average_rating": 4.8,
  "total_reviews": 125,
  "latest_comments": [
    {
      "customer": "Dayane",
      "stars": 5,
      "text": "Excelente!",
      "date": "2026-02-09"
    }
  ]
}
6. Erros, exceções e fallbackMatriz de erros:Token repetido: Retornar 409 Conflict.Falha no Resend: Logar erro (ERROR level) e aguardar reprocessamento pelo Scheduler no dia seguinte.Estratégias de resiliência: Retries com backoff exponencial na integração com o Resend.Invariantes: Um booking_id nunca pode ter mais de uma Review associada.7. ObservabilidadeMétricas:Taxa de Conversão: reviews_received_total / emails_sent_total.Volume de Conclusões Automáticas: Contador de execuções do Scheduler.Logs:Formato JSON estruturado incluindo booking_id, provider_id e status_envio.Dashboards e alertas:Alerta de erro crítico se falha no Resend exceder 5 ocorrências por hora.8. Dependências e compatibilidadeComponenteVersão mínimaObservaçõesFastAPI0.95.0+Necessário para suporte robusto a BackgroundTasksResend SDKLatestManter padrão de integração já existente9. Critérios de aceite técnicos[ ] O cliente não deve conseguir votar duas vezes com o mesmo link.[ ] A nota média do prestador deve ser recalculada em no máximo 30 segundos após a avaliação.[ ] O e-mail deve ser disparado sem aumentar o tempo de resposta (TTFB) do endpoint de conclusão.[ ] O Scheduler deve ignorar serviços já cancelados ou já concluídos.10. Riscos e mitigaçãoServiço não realizado (Falso Positivo)Probabilidade: médiaImpacto: Cliente recebe e-mail de avaliação de algo que não ocorreu (ex: cancelamento "por fora").Mitigação: Assumir o risco conforme definição de negócio; o cliente pode ignorar o e-mail.Plano de contingência: Caso o volume de reclamações suba, implementar no futuro um link "Não realizei este serviço".Deseja que eu exporte este documento no formato JSON estruturado para sua documentação técnica?
