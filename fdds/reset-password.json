{
  "meta": {
    "product_or_system": "ContrataPro",
    "feature_name": "Recuperação de Senha (Esqueci minha senha)",
    "fdd_owner": "ContrataPro Tech Team",
    "version": "1.0",
    "date": "2026-01-26"
  },
  "context": {
    "technical_motivation": "Permitir que usuários recuperem acesso à conta de forma autônoma e segura, reduzindo carga de suporte, utilizando a infraestrutura atual sem adicionar complexidade de filas externas.",
    "fit_with_hld": "Uso da autenticação existente (PostgreSQL), processamento assíncrono via FastAPI BackgroundTasks e envio via Resend (integrado ao Railway).",
    "actors": [
      "Usuário não autenticado",
      "API ContrataPro (Auth/Notifications)",
      "Serviço de Email (Resend)"
    ],
    "assumptions": [
      "O serviço de e-mail (Resend) possui alta disponibilidade.",
      "A persistência do token é baseada puramente na assinatura JWT (stateless) ou validação contra hash de senha atual."
    ],
    "constraints": [
      "Frontend em React + Tailwind.",
      "Sem infraestrutura de filas dedicada (RabbitMQ/Kafka).",
      "Deploy no Railway."
    ]
  },
  "technical_objectives": [
    {
      "objective": "Garantir privacidade do usuário contra enumeração de e-mails.",
      "measure_or_invariant": "Blind Response (Sempre retornar 200 OK na solicitação)."
    },
    {
      "objective": "Não bloquear a thread principal da API durante o envio.",
      "measure_or_invariant": "Uso obrigatório de BackgroundTasks (tempo de resposta < 200ms)."
    },
    {
      "objective": "Manter consistência de segurança de credenciais.",
      "measure_or_invariant": "Aplicação rigorosa da Regex de senha forte existente."
    }
  ],
  "scope": {
    "included": [
      "Componente Modal Responsivo (React/Tailwind)",
      "Endpoint POST para solicitação de reset (Blind Security)",
      "Geração de Token JWT (24h validade)",
      "Envio de e-mail assíncrono via Resend",
      "Tela de definição de nova senha com validação de token",
      "Endpoint POST para troca efetiva da senha",
      "Registro de histórico na tabela de notificações"
    ],
    "excluded": [
      "Autenticação automática pós-reset (Auto-login)",
      "Múltiplos fatores de autenticação (2FA/SMS)",
      "Perguntas de segurança"
    ]
  },
  "detailed_flows": {
    "main_flow": [
      "Usuário clica em 'Esqueci minha senha' na tela de login.",
      "Modal abre solicitando e-mail.",
      "Frontend envia POST /auth/forgot-password.",
      "Backend responde 200 OK imediatamente e agenda BackgroundTask.",
      "BackgroundTask verifica e-mail: se existe, gera JWT e envia link via Resend; registra log.",
      "Usuário clica no link do e-mail (/nova-senha?token=...).",
      "Frontend valida token via GET ao carregar a página.",
      "Usuário digita nova senha forte.",
      "Frontend submete POST /auth/reset-password.",
      "Backend altera senha, invalida tokens anteriores e retorna sucesso.",
      "Frontend redireciona para Login."
    ],
    "alternative_flows": [
      "E-mail não encontrado: API retorna 200, log interno registra 'UserNotFound', nenhum e-mail é enviado.",
      "Token expirado/inválido: API retorna 400/401 na validação, Frontend exibe erro e botão para reiniciar fluxo.",
      "Falha no Resend: Exceção capturada na BackgroundTask, log de erro crítico gerado, status 'failed' na tabela de notificações."
    ],
    "diagrams": []
  },
  "public_contracts": [
    {
      "name": "Solicitar Recuperação",
      "kind": "http_endpoint",
      "signature_or_route": "POST /auth/forgot-password",
      "method": "POST",
      "request_example": {
        "email": "user@example.com"
      },
      "response_example": {
        "message": "Se o e-mail estiver cadastrado, as instruções serão enviadas."
      },
      "headers_semantics": [],
      "status_semantics": [
        "200: Solicitação recebida com sucesso (independente de existência)"
      ],
      "limits": {
        "rate": "3 requests / hour / IP",
        "payload_size": "Standard JSON",
        "timeout": "5s (API response), BackgroundTask decoupled"
      },
      "versioning": "v1"
    },
    {
      "name": "Validar Token de Reset",
      "kind": "http_endpoint",
      "signature_or_route": "GET /auth/validate-reset-token",
      "method": "GET",
      "request_example": {
        "token": "eyJhbGciOiJIUzI1..."
      },
      "response_example": {
        "valid": true,
        "email": "user@example.com"
      },
      "headers_semantics": [],
      "status_semantics": [
        "200: Token Válido",
        "400: Token Inválido ou Expirado"
      ],
      "limits": {
        "rate": "No strict limit",
        "payload_size": "-",
        "timeout": "-"
      },
      "versioning": "v1"
    },
    {
      "name": "Redefinir Senha",
      "kind": "http_endpoint",
      "signature_or_route": "POST /auth/reset-password",
      "method": "POST",
      "request_example": {
        "token": "eyJhbGciOiJIUzI1...",
        "new_password": "StrongPassword123!"
      },
      "response_example": {
        "message": "Senha alterada com sucesso."
      },
      "headers_semantics": [],
      "status_semantics": [
        "200: Sucesso",
        "422: Senha fraca (não atende requisitos)"
      ],
      "limits": {
        "rate": "5 attempts / token",
        "payload_size": "-",
        "timeout": "-"
      },
      "versioning": "v1"
    }
  ],
  "errors_exceptions_fallback": {
    "error_matrix": [
      {
        "condition": "Token Expirado (> 24h)",
        "treatment": "Retornar HTTP 400/401. Frontend bloqueia UI.",
        "notes": "Usuário deve solicitar novo link."
      },
      {
        "condition": "Erro de conexão com Resend",
        "treatment": "Catch exception na BackgroundTask. Logar erro.",
        "notes": "Falha silenciosa para o usuário (API já respondeu 200)."
      }
    ],
    "resilience_strategies": [
      "circuit_breaker",
      "timeouts"
    ],
    "fallback_policy": "O usuário deve realizar nova solicitação caso não receba o e-mail em alguns minutos.",
    "invariants": [
      "Senha nova deve conter: min 8 chars, 1 maiúscula, 1 minúscula, 1 número, 1 especial.",
      "Token JWT deve ter expiração exata de 24 horas."
    ]
  },
  "observability": {
    "metrics": [
      "Count: Password Reset Requests",
      "Count: Emails Sent Successfully",
      "Count: Emails Failed (Resend Error)"
    ],
    "logs": {
      "format": "JSON Structured",
      "fields": [
        "action=forgot_password",
        "status",
        "user_id_masked",
        "error_detail"
      ]
    },
    "tracing": {
      "spans": [
        "API Request Handling",
        "Background Task Execution",
        "Resend API Call"
      ],
      "sampling": "100% on errors"
    },
    "dashboards_alerts": [
      "Alerta se taxa de falha no envio de e-mail > 5% em 10 min."
    ]
  },
  "dependencies_compatibility": {
    "dependencies": [
      {
        "component": "FastAPI BackgroundTasks",
        "min_version": "Atual",
        "notes": "Execução assíncrona simples"
      },
      {
        "component": "Resend SDK",
        "min_version": "Atual",
        "notes": "Envio transacional"
      },
      {
        "component": "React Frontend",
        "min_version": "18+",
        "notes": "Componente Modal"
      }
    ],
    "compatibility_guarantees": [
      "Compatibilidade visual com Tailwind CSS existente."
    ]
  },
  "acceptance_criteria": [
    "A API retorna 200 OK para e-mails cadastrados e não cadastrados (Blind Response).",
    "O e-mail contém um link válido por apenas 24 horas.",
    "O sistema rejeita senhas que não atendam à política forte (Regex validado).",
    "O status do envio é corretamente persistido na tabela de notificações.",
    "O fluxo funciona completamente em ambiente mobile (Responsividade)."
  ],
  "risks": [
    {
      "risk": "Enumeração de Usuários (Timing Attack)",
      "probability": "medium",
      "impact": "Privacidade de dados",
      "mitigation": [
        "Resposta padronizada (Blind Response) para todos os casos."
      ],
      "contingency_plan": "Implementar fake delay se detectado abuso."
    },
    {
      "risk": "Perda de E-mail (Reinício do Pod Railway)",
      "probability": "low",
      "impact": "Usuário não recebe link",
      "mitigation": [
        "Monitoramento de logs."
      ],
      "contingency_plan": "Usuário solicita novo link (ação manual)."
    }
  ]
}
